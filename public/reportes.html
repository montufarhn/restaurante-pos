<!-- public/reportes.html -->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Ventas</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header style="display: flex; justify-content: space-between; align-items: center; gap: 20px;">
            <div style="display: flex; align-items: center; gap: 20px;">
                <img id="restaurante-logo" src="" alt="Logo" style="max-height: 50px; display: none; border-radius: 8px;">
                <h1 id="titulo-principal" data-i18n="report_sales">Reporte de Ventas</h1>
            </div>
            <button id="btn-logout" class="btn-danger" data-i18n="logout">Cerrar Sesión</button>
        </header>
        <main>
            <div class="report-filters admin-panel">
                <h2 data-i18n="generate_report">Seleccionar Rango de Fechas</h2>
                <form id="form-reporte">
                    <div class="form-group">
                        <label for="fecha-inicio" data-i18n="date_start">Fecha de Inicio:</label>
                        <input type="date" id="fecha-inicio" required>
                    </div>
                    <div class="form-group">
                        <label for="fecha-fin" data-i18n="date_end">Fecha de Fin:</label>
                        <input type="date" id="fecha-fin" required>
                    </div>
                    <button type="submit" class="btn-success" data-i18n="generate_report">Generar Reporte</button>
                </form>
            </div>

            <div id="reporte-resultados" class="hidden">
                <div class="report-summary">
                    <div class="summary-card">
                        <h3 data-i18n="total_sales">Venta Total</h3>
                        <p id="total-ventas">0.00</p>
                    </div>
                    <div class="summary-card">
                        <h3 data-i18n="dishes_sold">Platillos Vendidos</h3>
                        <p id="total-platillos">0</p>
                    </div>
                    <div class="summary-card">
                        <h3 data-i18n="drinks_sold">Bebidas Vendidas</h3>
                        <p id="total-bebidas">0</p>
                    </div>
                </div>

                <div class="top-items-panel admin-panel">
                    <h2 data-i18n="top_items">Top 10 Productos Más Vendidos</h2>
                    <ol id="lista-top-items">
                        <!-- Los items más vendidos se cargarán aquí -->
                    </ol>
                </div>
            </div>

            <div class="admin-panel">
                <h2 data-i18n="history">Historial de Ventas</h2>
                <div class="report-actions">
                    <button id="exportar-btn" class="btn-secondary" data-i18n="export_excel">Exportar a Excel (CSV)</button>
                    <button id="reset-ventas-btn" class="btn-danger" data-i18n="reset_history">Resetear Historial</button>
                </div>
                <div class="table-container">
                    <table id="tabla-historial">
                        <thead>
                            <tr>
                                <th data-i18n="invoice_no">Factura N°</th>
                                <th data-i18n="date">Fecha</th>
                                <th data-i18n="subtotal">Subtotal</th>
                                <th data-i18n="tax">ISV</th>
                                <th data-i18n="total">Total</th>
                                <th data-i18n="actions">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="body-historial">
                            <!-- El historial de ventas se cargará aquí -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script src="locales.js"></script>
    <script>
        const formReporte = document.getElementById('form-reporte');
        const resultadosContainer = document.getElementById('reporte-resultados');
        const bodyHistorial = document.getElementById('body-historial');
        const exportarBtn = document.getElementById('exportar-btn');
        const resetVentasBtn = document.getElementById('reset-ventas-btn');
        let historialData = []; // Para almacenar los datos y usarlos en la exportación
        let monedaSymbol = 'L.';
        let currentLang = 'es';

        // Lógica de Logout
        document.getElementById('btn-logout').addEventListener('click', async () => {
            await fetch('/api/logout', { method: 'POST' });
            window.location.href = '/';
        });

        // Cargar configuración del restaurante
        async function cargarConfiguracion() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                
                monedaSymbol = config.moneda || 'L.';
                currentLang = config.idioma || 'es';

                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    if (translations[currentLang][key]) {
                        el.textContent = translations[currentLang][key];
                    }
                });

                if (config.nombre) {
                    const titulo = `${translations[currentLang]['reports_title']} - ${config.nombre}`;
                    document.getElementById('titulo-principal').textContent = titulo;
                    document.title = titulo;
                }
                if (config.logo) {
                    const logoImg = document.getElementById('restaurante-logo');
                    logoImg.src = config.logo;
                    logoImg.style.display = 'block';
                }
            } catch (error) {
                console.error('Error al cargar la configuración:', error);
            }
        }

        formReporte.addEventListener('submit', async (e) => {
            e.preventDefault();
            const fechaInicio = document.getElementById('fecha-inicio').value;
            const fechaFin = document.getElementById('fecha-fin').value;

            if (!fechaInicio || !fechaFin) {
                alert(translations[currentLang]['alert_select_dates']);
                return;
            }

            // Construir la URL con los parámetros de fecha
            const url = `/api/reportes?fechaInicio=${fechaInicio}&fechaFin=${fechaFin}`;
            const response = await fetch(url);

            if (!response.ok) {
                alert(translations[currentLang]['alert_report_error']);
                return;
            }

            const reporte = await response.json();
            mostrarResultados(reporte);
        });

        function mostrarResultados(reporte) {
            // Mostrar los totales
            document.getElementById('total-ventas').textContent = `${monedaSymbol} ${reporte.ventaTotal.toFixed(2)}`;
            document.getElementById('total-platillos').textContent = reporte.totalPlatillos;
            document.getElementById('total-bebidas').textContent = reporte.totalBebidas;

            // Mostrar el top 10
            const listaTopItems = document.getElementById('lista-top-items');
            listaTopItems.innerHTML = '';

            if (reporte.topItems.length === 0) {
                listaTopItems.innerHTML = '<li>No hay datos para el rango seleccionado.</li>';
            } else {
                reporte.topItems.forEach(item => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <span>${item.nombre}</span>
                        <span>${translations[currentLang]['label_sold']} <strong>${item.cantidad}</strong></span>
                    `;
                    listaTopItems.appendChild(li);
                });
            }

            // Hacer visible el contenedor de resultados
            resultadosContainer.classList.remove('hidden');
        }

        // Cargar el historial completo de ventas al iniciar
        async function cargarHistorial() {
            const response = await fetch('/api/reportes/historial');
            if (!response.ok) {
                bodyHistorial.innerHTML = `<tr><td colspan="6">${translations[currentLang]['msg_error_history']}</td></tr>`;
                return;
            }

            historialData = await response.json(); // Guardar los datos en la variable global
            bodyHistorial.innerHTML = ''; // Limpiar la tabla antes de agregar nuevas filas
            if (historialData.length === 0) {
                bodyHistorial.innerHTML = `<tr><td colspan="6">${translations[currentLang]['msg_no_sales']}</td></tr>`;
            } else {
                historialData.forEach(venta => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${venta.id.toString().padStart(5, '0')}</td>
                        <td>${new Date(venta.fecha).toLocaleString('es-HN')}</td>
                        <td>${monedaSymbol} ${venta.subtotal.toFixed(2)}</td>
                        <td>${monedaSymbol} ${venta.isv.toFixed(2)}</td>
                        <td>${monedaSymbol} ${venta.total.toFixed(2)}</td>
                        <td><a href="/factura.html?ordenId=${venta.id}" target="_blank" class="btn-secondary" style="padding: 5px 10px; text-decoration: none;">${translations[currentLang]['view_invoice']}</a></td>
                    `;
                    bodyHistorial.appendChild(tr);
                });
            }
        }

        function exportarACSV(data) {
            if (data.length === 0) {
                alert(translations[currentLang]['msg_no_data_export']);
                return;
            }

            const headers = [
                translations[currentLang]['invoice_no'], 
                translations[currentLang]['date'], 
                `${translations[currentLang]['subtotal']} (${monedaSymbol})`, 
                `${translations[currentLang]['tax']} (${monedaSymbol})`, 
                `${translations[currentLang]['total']} (${monedaSymbol})`
            ];
            const csvRows = [headers.join(',')]; // Fila de encabezado

            // Crear una fila por cada venta
            data.forEach(row => {
                const values = [
                    `"${row.id.toString().padStart(5, '0')}"`,
                    `"${new Date(row.fecha).toLocaleString('es-HN')}"`,
                    row.subtotal.toFixed(2),
                    row.isv.toFixed(2),
                    row.total.toFixed(2)
                ];
                csvRows.push(values.join(','));
            });

            const csvString = csvRows.join('\n');
            const blob = new Blob([`\uFEFF${csvString}`], { type: 'text/csv;charset=utf-8;' }); // \uFEFF para compatibilidad con Excel
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `historial_ventas_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Carga inicial del historial
        cargarConfiguracion();
        cargarHistorial();

        // Evento para exportar
        exportarBtn.addEventListener('click', () => exportarACSV(historialData));

        // Evento para resetear las ventas
        resetVentasBtn.addEventListener('click', async () => {
            const confirmacion1 = confirm(translations[currentLang]['confirm_reset_1']);
            if (!confirmacion1) {
                return;
            }

            const confirmacion2 = confirm(translations[currentLang]['confirm_reset_2']);
            if (!confirmacion2) {
                return;
            }

            try {
                const response = await fetch('/api/ventas/reset', { method: 'POST' });
                if (response.ok) {
                    alert(translations[currentLang]['alert_history_reset']);
                    location.reload(); // Recargar la página para ver los cambios
                } else {
                    throw new Error('Falló la solicitud de reseteo.');
                }
            } catch (error) {
                alert(translations[currentLang]['alert_reset_error']);
                console.error(error);
            }
        });
    </script>
</body>
</html>