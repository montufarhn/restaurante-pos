<!-- public/cocina.html -->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pantalla de Cocina</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header style="display: flex; justify-content: space-between; align-items: center; gap: 20px;">
            <div style="display: flex; align-items: center; gap: 20px;">
                <img id="restaurante-logo" src="" alt="Logo" style="max-height: 50px; display: none; border-radius: 8px;">
                <h1 id="titulo-principal">Pantalla de Cocina</h1>
            </div>
            <button id="btn-logout" class="btn-danger" data-i18n="logout">Cerrar Sesión</button>
        </header>
        <main id="ordenes-pendientes" class="kds-layout">
            <!-- Las órdenes nuevas aparecerán aquí en tiempo real -->
        </main>
    </div>

    <!-- Importar la librería de Socket.IO para el cliente -->
    <script src="/socket.io/socket.io.js"></script>
    <script src="locales.js"></script>
    <script>
        const socket = io();
        const ordenesContainer = document.getElementById('ordenes-pendientes');
        let currentLang = 'es';

        // Lógica de Logout
        document.getElementById('btn-logout').addEventListener('click', async () => {
            await fetch('/api/logout', { method: 'POST' });
            window.location.href = '/';
        });

        // Cargar configuración del restaurante
        async function cargarConfiguracion() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                currentLang = config.idioma || 'es';
                if (config.nombre) {
                    const titulo = `${translations[currentLang]['kitchen_title']} - ${config.nombre}`;
                    document.getElementById('titulo-principal').textContent = titulo;
                    document.title = titulo;
                }
                if (config.logo) {
                    const logoImg = document.getElementById('restaurante-logo');
                    logoImg.src = config.logo;
                    logoImg.style.display = 'block';
                }
            } catch (error) {
                console.error('Error al cargar la configuración:', error);
            }
        }

        // Cargar las órdenes pendientes al iniciar la página
        async function cargarOrdenesPendientes() {
            const response = await fetch('/api/ordenes-pendientes');
            if (response.ok) {
                const ordenesPendientes = await response.json();
                ordenesPendientes.forEach(orden => renderizarOrden(orden));
            } else {
                console.error('Error al cargar órdenes pendientes');
            }
        }

        // Escuchar el evento 'nueva_orden' que envía el servidor
        socket.on('nueva_orden', (orden) => {
            console.log('Nueva orden recibida:', orden);
            renderizarOrden(orden);
        });

        // Escuchar cuando una orden se actualiza (ej: marcada como lista)
        socket.on('actualizar_estado_orden', ({ id, estado }) => {
            const ordenCard = document.getElementById(`orden-${id}`);
            if (ordenCard && estado === 'Lista') {
                ordenCard.classList.add('lista');
                ordenCard.querySelector('h3').textContent += ` - ${translations[currentLang]['ready']}`;
                // Opcional: removerla después de un tiempo
                setTimeout(() => ordenCard.remove(), 5000);
            }
        });

        function renderizarOrden(orden) {
            const ordenCard = document.createElement('div');
            ordenCard.className = 'orden-card';
            ordenCard.id = `orden-${orden.id}`;

            let itemsHtml = '<ul>';
            // Agrupar items para contar cantidades
            orden.items.forEach(item => {
                itemsHtml += `<li><strong>${item.cantidad}x</strong> ${item.nombre}</li>`;
            });
            itemsHtml += '</ul>';

            ordenCard.innerHTML = `
                <h3>${translations[currentLang]['label_order_num']}${orden.id}</h3>
                ${itemsHtml}
                <button class="btn-lista">${translations[currentLang]['mark_ready']}</button>
            `;

            ordenesContainer.prepend(ordenCard); // Añadir al principio

            // Añadir evento al botón para marcar como lista
            ordenCard.querySelector('.btn-lista').addEventListener('click', () => {
                // Enviar evento al servidor para notificar que está lista
                socket.emit('orden_lista', orden.id);
            });
        }

        // Carga inicial
        cargarConfiguracion().then(cargarOrdenesPendientes);
    </script>
</body>
</html>
