<!-- public/factura.html -->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Factura</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="factura-body">

    <div class="no-print" style="padding: 10px; display: flex; justify-content: flex-end; background-color: #f8f9fa; border-bottom: 1px solid #ddd; margin-bottom: 20px;">
        <button id="btn-logout" class="btn-danger" data-i18n="logout">Cerrar Sesión</button>
    </div>

    <div class="factura-container">
        <div id="factura-content">
            <!-- La información se cargará aquí dinámicamente -->
            <div class="text-center">
                <img id="logo" src="" alt="Logo" style="max-width: 100px; display: none;">
                <h2 id="nombre-restaurante"></h2>
                <p><span data-i18n="rtn">RTN</span>: <span id="rtn"></span></p>
            </div>

            <hr>

            <div class="text-center">
                <h3 data-i18n="invoice_title">FACTURA</h3>
                <p><strong data-i18n="invoice_no">N°</strong>: <span id="numero-factura"></span></p>
                <p><strong data-i18n="date">Fecha</strong>: <span id="fecha-factura"></span></p>
            </div>

            <hr>

            <div class="factura-items">
                <table>
                    <thead>
                        <tr>
                            <th data-i18n="quantity">Cant.</th>
                            <th data-i18n="description">Descripción</th>
                            <th data-i18n="total">Total</th>
                        </tr>
                    </thead>
                    <tbody id="items-factura">
                        <!-- Items de la orden -->
                    </tbody>
                </table>
            </div>

            <hr>

            <div class="factura-totales">
                <p><strong data-i18n="subtotal">SUBTOTAL</strong>: <span id="moneda-1"></span> <span id="subtotal"></span></p>
                <p><strong id="tax-label" data-i18n="tax">ISV</strong>: <span id="moneda-2"></span> <span id="isv"></span></p>
                <p><strong data-i18n="total_pay">TOTAL A PAGAR</strong>: <span id="moneda-3"></span> <span id="total-pagar"></span></p>
            </div>

            <hr>

            <div class="text-center factura-footer">
                <p><strong data-i18n="cai">CAI</strong>: <span id="cai"></span></p>
                <p><strong data-i18n="billing_range_msg">Rango de Facturación</strong>: <span id="rango-inicio"></span> - <span id="rango-fin"></span></p>
                <p data-i18n="thanks">¡Gracias por su compra!</p>
            </div>
        </div>
    </div>

    <script src="locales.js"></script>
    <script>
        async function cargarFactura() {
            const params = new URLSearchParams(window.location.search);
            const ordenId = params.get('ordenId');

            if (!ordenId) {
                document.body.innerHTML = '<h1>Error: No se especificó un ID de orden.</h1>';
                return;
            }

            // Cargar datos de la orden y configuración del restaurante simultáneamente
            const [ordenRes, configRes] = await Promise.all([
                fetch(`/api/ordenes/${ordenId}`),
                fetch('/api/config')
            ]);

            if (!ordenRes.ok || !configRes.ok) {
                document.body.innerHTML = '<h1>Error al cargar los datos de la factura.</h1>';
                return;
            }

            const orden = await ordenRes.json();
            const config = await configRes.json();

            // Aplicar traducciones
            const lang = config.idioma || 'es';
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang][key]) {
                    el.textContent = translations[lang][key];
                }
            });

            // Calcular porcentaje de impuesto para mostrar
            const taxRate = config.tasaImpuesto || 0.15;
            const taxPercent = (taxRate * 100).toFixed(1).replace('.0', '');
            const taxName = translations[lang]['tax'];
            document.getElementById('tax-label').textContent = `${taxName} (${taxPercent}%):`;

            // Llenar datos del restaurante
            if (config.logo) {
                document.getElementById('logo').src = config.logo;
                document.getElementById('logo').style.display = 'block';
            }
            document.getElementById('nombre-restaurante').textContent = config.nombre;
            document.title = `${translations[lang]['invoice_title']} - ${config.nombre}`;
            document.getElementById('rtn').textContent = config.rtn;
            document.getElementById('cai').textContent = config.cai;
            document.getElementById('rango-inicio').textContent = config.rangoInicio;
            document.getElementById('rango-fin').textContent = config.rangoFin;

            // Llenar datos de la orden
            document.getElementById('numero-factura').textContent = orden.id.toString().padStart(5, '0');
            document.getElementById('fecha-factura').textContent = new Date(orden.fecha).toLocaleString('es-HN');
            document.getElementById('subtotal').textContent = orden.subtotal.toFixed(2);
            document.getElementById('isv').textContent = orden.isv.toFixed(2);
            document.getElementById('total-pagar').textContent = orden.total.toFixed(2);

            // Moneda
            const moneda = config.moneda || 'L.';
            document.getElementById('moneda-1').textContent = moneda;
            document.getElementById('moneda-2').textContent = moneda;
            document.getElementById('moneda-3').textContent = moneda;

            // Llenar items
            const itemsTbody = document.getElementById('items-factura');
            const itemCounts = {};
            orden.items.forEach(item => {
                itemCounts[item.nombre] = (itemCounts[item.nombre] || { count: 0, price: item.precio });
                itemCounts[item.nombre].count++;
            });

            for (const nombre in itemCounts) {
                const item = itemCounts[nombre];
                itemsTbody.innerHTML += `<tr><td>${item.count}</td><td>${nombre}</td><td>${(item.count * item.price).toFixed(2)}</td></tr>`;
            }

            // Imprimir automáticamente al cargar
            window.print();
        }

        // Lógica de Logout
        document.getElementById('btn-logout').addEventListener('click', async () => {
            await fetch('/api/logout', { method: 'POST' });
            // Redirigir al login (index.html)
            window.location.href = '/';
        });

        window.onload = cargarFactura;
    </script>
</body>
</html>