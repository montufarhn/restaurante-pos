<!-- public/factura.html -->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Factura</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="factura-body">

    <div class="factura-container">
        <div id="factura-content">
            <!-- La información se cargará aquí dinámicamente -->
            <div class="text-center">
                <img id="logo" src="" alt="Logo" style="max-width: 100px; display: none;">
                <h2 id="nombre-restaurante"></h2>
                <p>RTN: <span id="rtn"></span></p>
            </div>

            <hr>

            <div class="text-center">
                <h3>FACTURA</h3>
                <p><strong>N°:</strong> <span id="numero-factura"></span></p>
                <p><strong>Fecha:</strong> <span id="fecha-factura"></span></p>
            </div>

            <hr>

            <div class="factura-items">
                <table>
                    <thead>
                        <tr>
                            <th>Cant.</th>
                            <th>Descripción</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody id="items-factura">
                        <!-- Items de la orden -->
                    </tbody>
                </table>
            </div>

            <hr>

            <div class="factura-totales">
                <p><strong>SUBTOTAL:</strong> L. <span id="subtotal"></span></p>
                <p><strong>ISV (15%):</strong> L. <span id="isv"></span></p>
                <p><strong>TOTAL A PAGAR:</strong> L. <span id="total-pagar"></span></p>
            </div>

            <hr>

            <div class="text-center factura-footer">
                <p><strong>CAI:</strong> <span id="cai"></span></p>
                <p><strong>Rango de Facturación:</strong> <span id="rango-inicio"></span> al <span id="rango-fin"></span></p>
                <p>¡Gracias por su compra!</p>
            </div>
        </div>
    </div>

    <script>
        async function cargarFactura() {
            const params = new URLSearchParams(window.location.search);
            const ordenId = params.get('ordenId');

            if (!ordenId) {
                document.body.innerHTML = '<h1>Error: No se especificó un ID de orden.</h1>';
                return;
            }

            // Cargar datos de la orden y configuración del restaurante simultáneamente
            const [ordenRes, configRes] = await Promise.all([
                fetch(`/api/ordenes/${ordenId}`),
                fetch('/api/config')
            ]);

            if (!ordenRes.ok || !configRes.ok) {
                document.body.innerHTML = '<h1>Error al cargar los datos de la factura.</h1>';
                return;
            }

            const orden = await ordenRes.json();
            const config = await configRes.json();

            // Llenar datos del restaurante
            if (config.logo) {
                document.getElementById('logo').src = config.logo;
                document.getElementById('logo').style.display = 'block';
            }
            document.getElementById('nombre-restaurante').textContent = config.nombre;
            document.getElementById('rtn').textContent = config.rtn;
            document.getElementById('cai').textContent = config.cai;
            document.getElementById('rango-inicio').textContent = config.rangoInicio;
            document.getElementById('rango-fin').textContent = config.rangoFin;

            // Llenar datos de la orden
            document.getElementById('numero-factura').textContent = orden.id.toString().padStart(5, '0');
            document.getElementById('fecha-factura').textContent = new Date(orden.fecha).toLocaleString('es-HN');
            document.getElementById('subtotal').textContent = orden.subtotal.toFixed(2);
            document.getElementById('isv').textContent = orden.isv.toFixed(2);
            document.getElementById('total-pagar').textContent = orden.total.toFixed(2);

            // Llenar items
            const itemsTbody = document.getElementById('items-factura');
            const itemCounts = {};
            orden.items.forEach(item => {
                itemCounts[item.nombre] = (itemCounts[item.nombre] || { count: 0, price: item.precio });
                itemCounts[item.nombre].count++;
            });

            for (const nombre in itemCounts) {
                const item = itemCounts[nombre];
                itemsTbody.innerHTML += `<tr><td>${item.count}</td><td>${nombre}</td><td>${(item.count * item.price).toFixed(2)}</td></tr>`;
            }

            // Imprimir automáticamente al cargar
            window.print();
        }

        window.onload = cargarFactura;
    </script>
</body>
</html>