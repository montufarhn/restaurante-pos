<!-- public/caja.html -->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Punto de Venta (POS)</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <div style="display: flex; align-items: center; gap: 20px;">
                <img id="restaurante-logo" src="" alt="Logo" style="max-height: 50px; display: none; border-radius: 8px;">
                <h1 id="titulo-principal" data-i18n="pos_title">Punto de Venta</h1>
            </div>
            <div style="display: flex; gap: 10px;">
                <button id="manage-menu-btn" class="btn-secondary" data-i18n="manage_menu">Administrar Men칰</button>
                <button id="btn-logout" class="btn-danger" data-i18n="logout">Cerrar Sesi칩n</button>
            </div>
        </header>
        <main class="pos-layout">
            <div class="menu-panel">
                <h2 data-i18n="menu_title">Men칰</h2>
                <div id="menu-items"></div>
            </div>
            <div class="orden-panel">
                <h2 data-i18n="current_order">Orden Actual</h2>
                <ul id="orden-items">
                    <!-- Los items de la orden aparecer치n aqu칤 -->
                </ul>
                
                <!-- Panel de Cliente -->
                <div class="cliente-panel" style="margin-bottom: 15px; padding: 10px; background: #f9f9f9; border-radius: 5px; border: 1px solid #ddd;">
                    <h3 style="margin-top: 0; font-size: 1em;">Datos del Cliente (Opcional)</h3>
                    <div style="position: relative; margin-bottom: 10px;">
                        <input type="text" id="buscar-cliente" placeholder="游댌 Buscar por Nombre o RTN..." style="width: 100%; padding: 8px; box-sizing: border-box;">
                        <div id="lista-resultados-clientes" style="position: absolute; width: 100%; background: white; border: 1px solid #ddd; z-index: 100; display: none; max-height: 150px; overflow-y: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></div>
                    </div>
                    <input type="hidden" id="cliente-id">
                    <input type="text" id="cliente-nombre" placeholder="Nombre del Cliente" style="width: 100%; padding: 8px; margin-bottom: 5px; box-sizing: border-box;">
                    <input type="text" id="cliente-rtn" placeholder="RTN (Opcional)" style="width: 100%; padding: 8px; margin-bottom: 5px; box-sizing: border-box;">
                    <button id="btn-guardar-cliente" class="btn-secondary" style="width: 100%; font-size: 0.9em; padding: 5px;">Guardar / Actualizar Cliente</button>
                </div>

                <div class="orden-summary" style="font-size: 1.1em;">
                    <p><span data-i18n="subtotal">Subtotal</span>: <span id="orden-subtotal">0.00</span></p>
                    <p><span id="tax-label" data-i18n="tax">Impuesto</span>: <span id="orden-isv">0.00</span></p>
                    <div class="orden-total">
                        <strong><span data-i18n="total">Total</span>: <span id="orden-total">0.00</span></strong>
                    </div>
                </div>
                <div id="pago-panel" class="pago-panel hidden">
                    <h3 data-i18n="calc_change">Calcular Cambio</h3>
                    <div class="form-group">
                        <label for="monto-pagado"><span data-i18n="pay_with">Cliente paga con</span> (<span class="moneda-symbol"></span>):</label>
                        <input type="number" id="monto-pagado" step="0.01" min="0" style="font-size: 1.2em; padding: 10px;">
                    </div>
                    <button id="calcular-cambio-btn" class="btn-success" data-i18n="calc_change">Calcular</button>
                    <div id="resultado-cambio" class="resultado-cambio hidden">
                        <h4><span data-i18n="change_due">Cambio a entregar</span>: <span id="cambio-a-dar">0.00</span></h4>
                    </div>
                </div>
                <div class="pos-actions" style="margin-top: 15px;">
                    <button id="enviar-orden-btn" data-i18n="send_kitchen">Enviar a Cocina</button>
                    <button id="imprimir-factura-btn" class="btn-secondary hidden" data-i18n="print_invoice">Imprimir Factura</button>
                    <button id="nueva-orden-btn" class="btn-success hidden" data-i18n="new_order">Nueva Orden</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal de Administraci칩n -->
    <div id="admin-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <div class="admin-layout">
                <div class="admin-panel">
                    <h2 id="form-title" data-i18n="add_item">A침adir Nuevo Item</h2>
                    <form id="form-item">
                        <input type="hidden" id="item-id">
                        <div class="form-group">
                            <label for="nombre" data-i18n="name">Nombre:</label>
                            <input type="text" id="nombre" name="nombre" required>
                        </div>
                        <div class="form-group">
                            <label for="precio"><span data-i18n="price">Precio</span> (<span class="moneda-symbol"></span>):</label>
                            <input type="number" id="precio" name="precio" step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="categoria" data-i18n="category">Categor칤a:</label>
                            <select id="categoria" name="categoria" required>
                                <option value="Platillo" data-i18n="dish">Platillo</option>
                                <option value="Bebida" data-i18n="drink">Bebida</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="imagen" data-i18n="image">Imagen del Producto:</label>
                            <input type="file" id="imagen" name="imagen" accept="image/*">
                            <div id="imagen-preview-container" style="margin-top: 10px; display: none;">
                                <img id="imagen-preview" src="" alt="Vista previa" style="max-height: 100px; border-radius: 5px;">
                            </div>
                        </div>
                        <div class="form-group form-group-checkbox">
                            <input type="checkbox" id="impuesto_incluido" name="impuesto_incluido" checked>
                            <label id="label-impuesto-incluido" for="impuesto_incluido" data-i18n="price_includes_tax">Precio incluye ISV</label>
                        </div>
                        <button type="submit" class="btn-success" data-i18n="save_item">Guardar Item</button>
                        <button type="button" id="cancel-edit-btn" class="btn-secondary hidden" data-i18n="cancel">Cancelar Edici칩n</button>
                    </form>
                </div>
                <div class="admin-panel">
                    <h2 data-i18n="current_menu_admin">Men칰 Actual</h2>
                    <ul id="lista-menu-admin"></ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Importar la librer칤a de Socket.IO para el cliente -->
    <script src="/socket.io/socket.io.js"></script>
    <script src="locales.js"></script>
    <script>
        const menuItemsContainer = document.getElementById('menu-items');
        const ordenItemsList = document.getElementById('orden-items');
        const ordenSubtotalSpan = document.getElementById('orden-subtotal');
        const ordenIsvSpan = document.getElementById('orden-isv');
        const ordenTotalSpan = document.getElementById('orden-total');
        const enviarOrdenBtn = document.getElementById('enviar-orden-btn');
        const imprimirFacturaBtn = document.getElementById('imprimir-factura-btn');
        const nuevaOrdenBtn = document.getElementById('nueva-orden-btn');
        const pagoPanel = document.getElementById('pago-panel');
        const calcularCambioBtn = document.getElementById('calcular-cambio-btn');
        const resultadoCambio = document.getElementById('resultado-cambio');
        
        // Elementos de Cliente
        const inputBuscarCliente = document.getElementById('buscar-cliente');
        const listaClientes = document.getElementById('lista-resultados-clientes');
        const inputClienteNombre = document.getElementById('cliente-nombre');
        const inputClienteRtn = document.getElementById('cliente-rtn');
        const inputClienteId = document.getElementById('cliente-id');
        const btnGuardarCliente = document.getElementById('btn-guardar-cliente');

        // Elementos del Modal de Admin
        const adminModal = document.getElementById('admin-modal');
        const manageMenuBtn = document.getElementById('manage-menu-btn');
        const closeBtn = document.querySelector('.close-button');
        const formItem = document.getElementById('form-item');
        const listaMenuAdmin = document.getElementById('lista-menu-admin');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');

        let ordenActual = [];
        let menu = [];
        let totalDeLaOrden = 0;
        let ultimaOrdenId = null;
        let currentLang = 'es';
        let monedaSymbol = 'L.'; // Valor por defecto
        let taxRate = 0.15; // Valor por defecto (15%)

        // L칩gica de Logout
        document.getElementById('btn-logout').addEventListener('click', async () => {
            await fetch('/api/logout', { method: 'POST' });
            window.location.href = '/';
        });

        // Conectar al servidor de sockets
        const socket = io();

        // Cargar configuraci칩n del restaurante
        async function cargarConfiguracion() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                
                monedaSymbol = config.moneda || 'L.';
                taxRate = config.tasaImpuesto || 0.15;
                currentLang = config.idioma || 'es';

                // Actualizar s칤mbolos de moneda en la UI
                document.querySelectorAll('.moneda-symbol').forEach(el => el.textContent = monedaSymbol);

                // Traducir UI
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    if (translations[currentLang][key]) {
                        el.textContent = translations[currentLang][key];
                    }
                });

                // Actualizar etiquetas de impuestos con el porcentaje correcto
                const taxPercent = (taxRate * 100).toFixed(1).replace('.0', ''); // 15.0 -> 15, 12.5 -> 12.5
                const taxName = translations[currentLang]['tax'];
                document.getElementById('tax-label').textContent = `${taxName} (${taxPercent}%)`;
                document.getElementById('label-impuesto-incluido').textContent = `${translations[currentLang]['price_includes_tax']} (${taxPercent}%)`;

                if (config.nombre) {
                    const titulo = `${translations[currentLang]['pos_title']} - ${config.nombre}`;
                    document.getElementById('titulo-principal').textContent = titulo;
                    document.title = titulo;
                }
                if (config.logo) {
                    const logoImg = document.getElementById('restaurante-logo');
                    logoImg.src = config.logo;
                    logoImg.style.display = 'block';
                }
            } catch (error) {
                console.error('Error al cargar la configuraci칩n:', error);
            }
        }

        // Cargar el men칰 desde el servidor
        async function cargarMenu() {
            try {
                const response = await fetch('/api/menu');
                if (!response.ok) {
                    throw new Error(`${translations[currentLang]['server_error']} ${response.status}`);
                }
                const data = await response.json();
                
                // Verificar que recibimos un arreglo (lista) y no un error
                if (Array.isArray(data)) {
                    // Asegurar que el precio sea un n칰mero para evitar errores con toFixed
                    menu = data.map(item => ({
                        ...item,
                        precio: parseFloat(item.precio)
                    }));
                    renderizarMenu();
                } else {
                    console.error('El formato de datos recibido no es v치lido:', data);
                    alert(translations[currentLang]['invalid_data']);
                }
            } catch (error) {
                console.error('Error al cargar el men칰:', error);
                alert(translations[currentLang]['connection_error']);
            }
        }

        // Mostrar el men칰 en la pantalla
        function renderizarMenu() {
            menuItemsContainer.innerHTML = '';
            
            if (menu.length === 0) {
                menuItemsContainer.innerHTML = `<p style="grid-column: 1/-1; text-align: center; padding: 20px; color: #666; font-size: 1.2em;">${translations[currentLang]['msg_menu_empty']}</p>`;
                return;
            }

            menu.forEach(item => {
                // L칩gica visual de Stock (si el backend lo provee)
                let stockHtml = '';
                if (item.stock !== undefined && item.stock !== null) {
                    const color = item.stock > 10 ? 'green' : (item.stock > 0 ? 'orange' : 'red');
                    stockHtml = `<div style="font-size: 0.8em; color: ${color}; margin-top: 5px; font-weight: bold;">Stock: ${item.stock}</div>`;
                }

                const itemDiv = document.createElement('div');
                itemDiv.className = 'menu-item';
                itemDiv.innerHTML = `
                    ${item.imagen ? `<img src="${item.imagen}" alt="${item.nombre}">` : `<div class="no-image">${translations[currentLang]['no_image']}</div>`}
                    <strong>${item.nombre}</strong>
                    <span class="price">${monedaSymbol} ${item.precio.toFixed(2)}</span>
                    ${stockHtml}
                `;
                itemDiv.onclick = () => agregarAOrden(item);
                menuItemsContainer.appendChild(itemDiv);
            });
        }

        // Agregar un item a la orden actual
        function agregarAOrden(item) {
            // Buscar si el item ya existe en la orden para agruparlo
            const existingItem = ordenActual.find(i => i.id === item.id);
            if (existingItem) {
                existingItem.cantidad++;
            } else {
                ordenActual.push({ ...item, cantidad: 1 });
            }
            renderizarOrden();
        }

        // Mostrar la orden actual en la pantalla
        function renderizarOrden() {
            ordenItemsList.innerHTML = '';
            let subtotalGeneral = 0;
            let isvGeneral = 0;

            ordenActual.forEach((item, index) => {
                let itemSubtotal, itemIsv, itemTotal;
                const precioTotalItem = item.precio * item.cantidad;

                if (item.impuesto_incluido) {
                    itemSubtotal = precioTotalItem / (1 + taxRate);
                    itemIsv = precioTotalItem - itemSubtotal;
                    itemTotal = precioTotalItem;
                } else {
                    itemSubtotal = precioTotalItem;
                    itemIsv = precioTotalItem * taxRate;
                    itemTotal = itemSubtotal + itemIsv;
                }

                subtotalGeneral += itemSubtotal;
                isvGeneral += itemIsv;

                const li = document.createElement('li');
                li.style.alignItems = 'center'; // Alinear verticalmente
                li.innerHTML = `
                    <div class="item-details" style="flex: 1;">
                        <div style="display: flex; justify-content: space-between;">
                            <span><strong>${item.cantidad}x</strong> ${item.nombre}</span>
                            <span>${monedaSymbol} ${itemTotal.toFixed(2)}</span>
                        </div>
                        <small>Sub: ${itemSubtotal.toFixed(2)} + ISV: ${itemIsv.toFixed(2)}</small>
                    </div>
                    <button class="btn-danger" onclick="eliminarItemOrden(${index})" style="margin-left: 10px; padding: 0; width: 30px; height: 30px; line-height: 30px; text-align: center; border-radius: 4px;">X</button>
                `;
                ordenItemsList.appendChild(li);
            });
            ordenSubtotalSpan.textContent = `${monedaSymbol} ${subtotalGeneral.toFixed(2)}`;
            ordenIsvSpan.textContent = `${monedaSymbol} ${isvGeneral.toFixed(2)}`;
            totalDeLaOrden = subtotalGeneral + isvGeneral;
            ordenTotalSpan.textContent = `${monedaSymbol} ${totalDeLaOrden.toFixed(2)}`;
        }

        // Funci칩n para eliminar o decrementar un item de la orden
        window.eliminarItemOrden = function(index) {
            if (ordenActual[index].cantidad > 1) {
                ordenActual[index].cantidad--;
            } else {
                ordenActual.splice(index, 1);
            }
            renderizarOrden();
        };

        // Enviar la orden al servidor
        async function enviarOrden() {
            if (ordenActual.length === 0) {
                alert(translations[currentLang]['alert_order_empty']);
                return;
            }

            // Aplanar la orden para el backend (convertir items agrupados a lista individual)
            const itemsFlat = [];
            ordenActual.forEach(item => {
                for (let i = 0; i < item.cantidad; i++) {
                    const { cantidad, ...itemData } = item; // Excluir propiedad cantidad para enviar limpio
                    itemsFlat.push(itemData);
                }
            });

            const clienteNombre = inputClienteNombre.value.trim();
            const clienteRtn = inputClienteRtn.value.trim();

            const response = await fetch('/api/ordenes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ items: itemsFlat, cliente_nombre: clienteNombre, cliente_rtn: clienteRtn })
            });

            if (!response.ok) {
                alert(translations[currentLang]['alert_error_sending_order']);
                return;
            }

            const ordenCreada = await response.json();
            ultimaOrdenId = ordenCreada.id;

            // Actualizar UI para el siguiente paso
            document.getElementById('menu-items').style.pointerEvents = 'none'; // Deshabilitar clics en el men칰
            document.getElementById('menu-items').style.opacity = '0.5';
            enviarOrdenBtn.classList.add('hidden');
            pagoPanel.classList.remove('hidden');
            document.getElementById('monto-pagado').focus();
            alert(translations[currentLang]['alert_order_sent'].replace('{id}', ultimaOrdenId));
        }

        // Calcular el cambio
        function calcularCambio() {
            const montoPagadoInput = document.getElementById('monto-pagado');
            const montoPagado = parseFloat(montoPagadoInput.value);

            if (isNaN(montoPagado) || montoPagado < totalDeLaOrden) {
                alert(translations[currentLang]['alert_payment_error']);
                montoPagadoInput.focus();
                return;
            }

            const cambio = montoPagado - totalDeLaOrden;
            document.getElementById('cambio-a-dar').textContent = `${monedaSymbol} ${cambio.toFixed(2)}`;

            // Mostrar resultado y botones finales
            resultadoCambio.classList.remove('hidden');
            imprimirFacturaBtn.classList.remove('hidden');
            nuevaOrdenBtn.classList.remove('hidden');
            calcularCambioBtn.classList.add('hidden');
            montoPagadoInput.disabled = true;
        }

        calcularCambioBtn.addEventListener('click', calcularCambio);
        enviarOrdenBtn.addEventListener('click', enviarOrden);

        imprimirFacturaBtn.addEventListener('click', () => {
            if (ultimaOrdenId) {
                window.open(`/factura.html?ordenId=${ultimaOrdenId}`, '_blank');
            }
        });

        nuevaOrdenBtn.addEventListener('click', () => {
            location.reload(); // La forma m치s simple de reiniciar el estado de la caja
        });

        // --- L칍GICA DE CLIENTES ---
        
        // Buscar cliente al escribir
        let debounceTimer;
        inputBuscarCliente.addEventListener('input', (e) => {
            clearTimeout(debounceTimer);
            const q = e.target.value;
            if (q.length < 2) {
                listaClientes.style.display = 'none';
                return;
            }
            debounceTimer = setTimeout(async () => {
                const res = await fetch(`/api/clientes?q=${encodeURIComponent(q)}`);
                const clientes = await res.json();
                listaClientes.innerHTML = '';
                if (clientes.length > 0) {
                    clientes.forEach(c => {
                        const div = document.createElement('div');
                        div.style.padding = '8px';
                        div.style.cursor = 'pointer';
                        div.style.borderBottom = '1px solid #eee';
                        div.innerHTML = `<strong>${c.nombre}</strong> <small>(${c.rtn || 'Sin RTN'})</small>`;
                        div.onmouseover = () => div.style.backgroundColor = '#f0f0f0';
                        div.onmouseout = () => div.style.backgroundColor = 'white';
                        div.onclick = () => {
                            inputClienteId.value = c.id;
                            inputClienteNombre.value = c.nombre;
                            inputClienteRtn.value = c.rtn || '';
                            listaClientes.style.display = 'none';
                            inputBuscarCliente.value = '';
                        };
                        listaClientes.appendChild(div);
                    });
                    listaClientes.style.display = 'block';
                } else {
                    listaClientes.style.display = 'none';
                }
            }, 300);
        });

        // Guardar o Actualizar Cliente
        btnGuardarCliente.addEventListener('click', async () => {
            const id = inputClienteId.value;
            const nombre = inputClienteNombre.value;
            const rtn = inputClienteRtn.value;

            if (!nombre) return alert("El nombre es obligatorio.");

            const url = id ? `/api/clientes/${id}` : '/api/clientes';
            const method = id ? 'PUT' : 'POST';

            const res = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nombre, rtn })
            });

            if (res.ok) {
                const data = await res.json();
                if (!id && data.id) inputClienteId.value = data.id; // Si era nuevo, guardamos el ID
                alert(id ? "Cliente actualizado." : "Cliente guardado.");
            } else {
                alert("Error al guardar cliente.");
            }
        });

        // Cerrar lista de b칰squeda si clic fuera
        document.addEventListener('click', (e) => {
            if (!inputBuscarCliente.contains(e.target) && !listaClientes.contains(e.target)) {
                listaClientes.style.display = 'none';
            }
        });

        // Cargar todo al iniciar
        // Aseguramos que primero cargue la config (moneda, impuestos) y luego el men칰
        cargarConfiguracion().then(() => cargarMenu());

        // --- L칍GICA DE ADMINISTRACI칍N DEL MEN칔 ---

        // Abrir/Cerrar modal
        manageMenuBtn.onclick = () => {
            adminModal.style.display = 'block';
            cargarMenuAdmin();
        };
        closeBtn.onclick = () => {
            adminModal.style.display = 'none';
            resetForm();
        };
        window.onclick = (event) => {
            if (event.target == adminModal) {
                adminModal.style.display = 'none';
                resetForm();
            }
        };

        // Cargar men칰 en el panel de admin
        async function cargarMenuAdmin() {
            // Reutilizamos la variable global 'menu' que ya se carga con cargarMenu()
            
            listaMenuAdmin.innerHTML = '';
            menu.forEach(item => {
                // Traducir categor칤a para mostrar
                const catKey = item.categoria === 'Platillo' ? 'dish' : 'drink';
                const catTranslated = translations[currentLang][catKey] || item.categoria;

                const li = document.createElement('li');
                li.className = 'admin-menu-item';
                li.innerHTML = `
                    <span>${item.nombre} (${catTranslated}) - ${monedaSymbol} ${item.precio.toFixed(2)}</span>
                    <div>
                        <button class="btn-edit" data-id="${item.id}">Editar</button>
                        <button class="btn-danger" data-id="${item.id}">Borrar</button>
                    </div>
                `;
                listaMenuAdmin.appendChild(li);
            });
        }

        // Resetear el formulario a modo "A침adir"
        function resetForm() {
            formItem.reset();
            document.getElementById('item-id').value = '';
            document.getElementById('form-title').textContent = 'A침adir Nuevo Item';
            document.getElementById('imagen-preview').src = '';
            document.getElementById('imagen-preview-container').style.display = 'none';
            cancelEditBtn.classList.add('hidden');
        }

        // Manejar env칤o del formulario (A침adir o Editar)
        formItem.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('item-id').value;
            const nombre = document.getElementById('nombre').value;
            const precio = parseFloat(document.getElementById('precio').value);
            const categoria = document.getElementById('categoria').value;
            const impuesto_incluido = document.getElementById('impuesto_incluido').checked;
            const imagenInput = document.getElementById('imagen');
            const imagenPreview = document.getElementById('imagen-preview');

            const url = id ? `/api/menu/${id}` : '/api/menu';
            const method = id ? 'PUT' : 'POST';

            // Usamos FormData para enviar archivos
            const formData = new FormData();
            formData.append('nombre', nombre);
            formData.append('precio', precio);
            formData.append('categoria', categoria);
            formData.append('impuesto_incluido', impuesto_incluido);
            
            if (imagenInput.files[0]) {
                formData.append('imagen', imagenInput.files[0]);
            } else if (id && imagenPreview.src) {
                // Si estamos editando y no se subi칩 nueva imagen, enviamos la URL actual (opcional, depende del backend)
                formData.append('imagen_actual', imagenPreview.src);
            }

            const response = await fetch(url, {
                method: method,
                body: formData // No establecemos Content-Type manualmente, fetch lo hace por nosotros con el boundary correcto
            });

            if (response.ok) {
                resetForm();
                // No es necesario llamar a cargarMenuAdmin() aqu칤, 
                // el evento 'menu_actualizado' de socket.io se encargar치 de refrescar todo.
            } else {
                const errorData = await response.json().catch(() => ({ message: 'El servidor no respondi칩 con un error JSON v치lido.' }));
                alert(`Error al guardar el item: ${errorData.message || response.statusText}`);
            }
        });

        // Manejar clics en la lista de men칰 (Editar/Borrar)
        listaMenuAdmin.addEventListener('click', async (e) => {
            const target = e.target;
            const id = target.dataset.id;

            // Bot칩n BORRAR
            if (target.classList.contains('btn-danger')) {
                if (confirm(translations[currentLang]['confirm_delete_item'])) {
                    const response = await fetch(`/api/menu/${id}`, { method: 'DELETE' });
                    if (!response.ok) {
                        alert(translations[currentLang]['alert_error_delete_item']);
                    }
                }
            }

            // Bot칩n EDITAR
            if (target.classList.contains('btn-edit')) {
                const itemToEdit = menu.find(item => item.id == id);
                if (itemToEdit) {
                    document.getElementById('item-id').value = itemToEdit.id;
                    document.getElementById('nombre').value = itemToEdit.nombre;
                    document.getElementById('precio').value = itemToEdit.precio;
                    document.getElementById('categoria').value = itemToEdit.categoria;
                    document.getElementById('impuesto_incluido').checked = !!itemToEdit.impuesto_incluido;
                    
                    if (itemToEdit.imagen) {
                        document.getElementById('imagen-preview').src = itemToEdit.imagen;
                        document.getElementById('imagen-preview-container').style.display = 'block';
                    } else {
                        document.getElementById('imagen-preview-container').style.display = 'none';
                    }

                    document.getElementById('form-title').textContent = 'Editando Item';
                    cancelEditBtn.classList.remove('hidden');
                }
            }
        });

        // Previsualizar imagen al seleccionar archivo
        document.getElementById('imagen').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('imagen-preview').src = URL.createObjectURL(file);
                document.getElementById('imagen-preview-container').style.display = 'block';
            }
        });

        // Bot칩n para cancelar la edici칩n
        cancelEditBtn.addEventListener('click', resetForm);

        // Sobrescribir la funci칩n de recarga para que tambi칠n actualice el panel de admin si est치 abierto
        socket.on('menu_actualizado', async () => {
            console.log('El men칰 ha sido actualizado. Recargando...');
            await cargarMenu(); // Recarga el men칰 principal
            if (adminModal.style.display === 'block') {
                cargarMenuAdmin(); // Si el modal est치 abierto, tambi칠n lo recarga
            }
        });
    </script>
</body>
</html>