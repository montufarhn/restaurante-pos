<!-- public/dashboard.html -->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema POS</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header style="display: flex; justify-content: space-between; align-items: center; gap: 20px;">
            <div style="display: flex; align-items: center; gap: 20px;">
                <img id="restaurante-logo" src="" alt="Logo" style="max-height: 80px; display: none; border-radius: 8px;">
                <h1 id="titulo-principal" data-i18n="system_title">Sistema POS</h1>
            </div>
            <div style="display: flex; align-items: center; gap: 20px;">
                <span id="username-display" style="font-weight: bold;"></span>
                <button id="btn-settings" style="background: none; border: none; font-size: 24px; cursor: pointer; color: white;" title="Configuración">⚙️</button>
                <button id="btn-logout" class="btn-danger" data-i18n="logout">Cerrar Sesión</button>
            </div>
        </header>
        <main id="dashboard-main" class="dashboard-layout">
            <!-- Los botones se generarán aquí dinámicamente -->
        </main>
    </div>

    <!-- Modal de Configuración Regional -->
    <div id="settings-modal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <span class="close-button">&times;</span>
            <h2 data-i18n="settings_global">Configuración Regional</h2>
            <form id="form-settings">
                <div class="form-group">
                    <label for="idioma" data-i18n="language">Idioma:</label>
                    <select id="idioma" name="idioma" style="width: 100%; padding: 10px;">
                        <option value="en">English</option>
                        <option value="es">Español</option>
                        <option value="fr">Français</option>
                        <option value="ja">日本語</option>
                        <option value="pt">Português</option>
                        <option value="zh">中文</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="moneda" data-i18n="currency">Moneda:</label>
                    <select id="moneda" name="moneda" style="width: 100%; padding: 10px;">
                        <option value="BZ$">Belize Dollar (BZ$)</option>
                        <option value="€">Euro (€)</option>
                        <option value="L.">Lempira (L.)</option>
                        <option value="£">Pound Sterling (£)</option>
                        <option value="Q">Quetzal (Q)</option>
                        <option value="$">US Dollar ($)</option>
                        <option value="CN¥">人民币 (¥)</option>
                        <option value="¥">日本円 (¥)</option>
                    </select>
                </div>
                <button type="submit" class="btn-success" style="width: 100%; margin-top: 10px;" data-i18n="save">Guardar</button>
            </form>
        </div>
    </div>

    <script src="locales.js"></script>
    <script>
        let currentConfig = {};
        let user = {};

        // Lógica del Modal (copiada de index.html anterior)
        const modal = document.getElementById('settings-modal');
        const btnSettings = document.getElementById('btn-settings');
        const span = document.getElementsByClassName("close-button")[0];
        btnSettings.onclick = () => modal.style.display = "block";
        span.onclick = () => modal.style.display = "none";
        window.onclick = (event) => { if (event.target == modal) modal.style.display = "none"; }

        // Lógica de Logout
        document.getElementById('btn-logout').addEventListener('click', async () => {
            await fetch('/api/logout', { method: 'POST' });
            window.location.href = '/';
        });

        // Guardar configuración regional
        document.getElementById('form-settings').addEventListener('submit', async (e) => {
            e.preventDefault();
            const nuevoIdioma = document.getElementById('idioma').value;
            const nuevaMoneda = document.getElementById('moneda').value;

            // Combinar con la configuración existente para no perder otros datos
            const nuevaConfig = { ...currentConfig, idioma: nuevoIdioma, moneda: nuevaMoneda };
            
            const formData = new FormData();
            // Reconstruir FormData para el servidor
            Object.keys(nuevaConfig).forEach(key => {
                // No enviar la tasa de impuesto calculada ni el logo como campo de texto
                if (key !== 'tasaImpuesto' && key !== 'logo') {
                    formData.append(key, nuevaConfig[key]);
                }
            });
            if (nuevaConfig.logo) formData.append('logo_actual', nuevaConfig.logo);

            await fetch('/api/config', { method: 'POST', body: formData });
            location.reload();
        });

        // Cargar datos de sesión y configuración
        async function inicializarDashboard() {
            const [sessionRes, configRes] = await Promise.all([fetch('/api/session'), fetch('/api/config')]);
            if (!sessionRes.ok) { window.location.href = '/'; return; }
            
            user = await sessionRes.json();
            currentConfig = await configRes.json();
            
            // INYECTAR TRADUCCIONES PARA INVENTARIO (Parche temporal)
            if (typeof translations !== 'undefined') {
                const newKeys = {
                    es: { inventory_title: 'Inventario', desc_inventory: 'Gestión de stock e ingredientes' },
                    en: { inventory_title: 'Inventory', desc_inventory: 'Stock and ingredient management' },
                    fr: { inventory_title: 'Inventaire', desc_inventory: 'Gestion des stocks et ingrédients' },
                    pt: { inventory_title: 'Inventário', desc_inventory: 'Gestão de estoque e ingredientes' },
                    ja: { inventory_title: '在庫', desc_inventory: '在庫と材料の管理' },
                    zh: { inventory_title: '库存', desc_inventory: '库存和配料管理' }
                };
                Object.keys(newKeys).forEach(l => { if (translations[l]) Object.assign(translations[l], newKeys[l]); });
            }

            document.getElementById('username-display').textContent = user.username;

            // Lógica de renderizado de botones según el rol
            const main = document.getElementById('dashboard-main');
            main.innerHTML = ''; // Limpiar
            const lang = currentConfig.idioma || 'es';

            const buttons = [
                { href: '/caja.html', title: 'pos_title', desc: 'desc_pos', roles: ['admin', 'caja'] },
                { href: '/cocina.html', title: 'kitchen_title', desc: 'desc_kitchen', roles: ['admin', 'caja', 'cocina'] },
                { href: '/inventario.html', title: 'inventory_title', desc: 'desc_inventory', roles: ['admin', 'caja'] },
                { href: '/admin.html', title: 'admin_title', desc: 'desc_admin', roles: ['admin'] },
                { href: '/reportes.html', title: 'reports_title', desc: 'desc_reports', roles: ['admin'] }
            ];

            buttons.filter(b => b.roles.includes(user.role)).forEach(b => {
                main.innerHTML += `
                    <a href="${b.href}" class="dashboard-button" target="_blank" rel="noopener noreferrer">
                        <h3>${translations[lang][b.title]}</h3>
                        <p>${translations[lang][b.desc]}</p>
                    </a>`;
            });

            // Aplicar traducciones a elementos estáticos
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang][key]) {
                    el.textContent = translations[lang][key];
                }
            });

            // Configurar título principal y de la pestaña
            if (currentConfig.nombre) {
                const titulo = `${currentConfig.nombre} - ${translations[lang]['system_title']}`;
                document.getElementById('titulo-principal').textContent = titulo;
                document.title = titulo;
            }

            // Mostrar logo
            if (currentConfig.logo) {
                document.getElementById('restaurante-logo').src = currentConfig.logo;
                document.getElementById('restaurante-logo').style.display = 'block';
            }

            // Sincronizar valores del modal de configuración
            document.getElementById('idioma').value = currentConfig.idioma || 'es';
            document.getElementById('moneda').value = currentConfig.moneda || 'L.';
        }

        inicializarDashboard();
    </script>
</body>
</html>